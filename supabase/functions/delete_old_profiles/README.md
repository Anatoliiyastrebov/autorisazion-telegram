# GDPR Automatic Deletion Function

Edge Function для автоматического удаления анкет пользователей по GDPR запросам.

## Описание

Эта функция автоматически обрабатывает запросы на удаление данных (GDPR) и удаляет анкеты пользователей через 7 дней (1 неделю) после создания запроса. Удаляются только анкеты, которые старше 1 недели с момента их создания.

## Структура

- `index.ts` - основной код Edge Function
- `deno.json` - конфигурация Deno
- `.env.example` - пример переменных окружения (для справки)

## Установка и деплой

### 1. Применить миграцию базы данных

```bash
# Применить миграцию для создания таблицы gdpr_requests
supabase migration up
```

Или через Supabase Dashboard:
- Перейдите в Database > Migrations
- Примените миграцию `003_gdpr_requests.sql`

### 2. Установить переменные окружения

Edge Function автоматически получает переменные окружения от Supabase, но убедитесь, что они установлены:

```bash
# Получить значения из Supabase Dashboard:
# Settings > API > Project URL и Service Role Key

# Установить secrets (если нужно):
supabase secrets set SUPABASE_URL=your-project-url
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

### 3. Деплой Edge Function

```bash
# Из корня проекта
supabase functions deploy delete_old_profiles
```

### 4. Настроить расписание (Scheduled Task)

Функция будет запускаться автоматически 1 раз в месяц (1-го числа каждого месяца в 00:00 UTC):

```bash
supabase functions schedule create delete_old_profiles --cron "0 0 1 * *"
```

## Как это работает

1. Пользователь создает запрос на удаление через форму на сайте
2. Запрос сохраняется в таблицу `gdpr_requests` со статусом `pending`
3. Поле `scheduled_delete_at` автоматически вычисляется как `created_at + 7 days` (1 неделя)
4. Edge Function `delete_old_profiles` запускается по расписанию (1 раз в месяц)
5. Функция находит все запросы со статусом `pending`, где `scheduled_delete_at <= now()`
6. Для каждого запроса:
   - Удаляет только анкеты из таблицы `questionnaires`, которые старше 1 недели (submitted_at < now() - 7 days)
   - Удаляет связанные сессии из таблицы `sessions`
   - Удаляет связанные OTP коды из таблицы `otp_codes`
   - Обновляет статус запроса на `deleted` или `failed`
   - Если остались анкеты новее 1 недели, они будут удалены при следующем запуске

## Идемпотентность

Функция полностью идемпотентна:
- Если анкеты уже удалены - ошибок не будет
- Если запросов нет - функция завершится успешно
- Если произошла ошибка - запрос помечается как `failed` и может быть обработан при следующем запуске

## Мониторинг

Логи функции доступны в Supabase Dashboard:
- Edge Functions > delete_old_profiles > Logs

Функция возвращает JSON с результатами:
```json
{
  "success": true,
  "message": "Processed 5 GDPR requests",
  "processed": 5,
  "successful": 5,
  "failed": 0
}
```

## Ручной запуск (для тестирования)

```bash
# Запустить функцию вручную
supabase functions invoke delete_old_profiles
```

## Проверка расписания

```bash
# Посмотреть все запланированные задачи
supabase functions schedule list
```

## Важные замечания

- Функция использует `SUPABASE_SERVICE_ROLE_KEY` для полного доступа к базе данных
- Удаление необратимо - данные удаляются навсегда
- Функция запускается 1 раз в месяц, но обрабатывает все запросы, которые готовы к удалению
- Период ожидания 7 дней (1 неделя) дает время для отмены запроса (если нужно)
- Удаляются только анкеты, которые старше 1 недели с момента их создания (submitted_at)
- Новые анкеты (младше 1 недели) не удаляются и будут обработаны при следующем запуске
