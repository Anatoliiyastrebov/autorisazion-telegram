# Безопасность и конфиденциальность данных

## Текущая реализация

### Проблема с localStorage
**ВНИМАНИЕ:** Текущая версия использует `localStorage` браузера для хранения анкет. Это **НЕБЕЗОПАСНО** для продакшена, так как:
- Данные хранятся в открытом виде в браузере
- Любой скрипт на странице может получить доступ к данным
- Данные не синхронизируются между устройствами
- Нет шифрования

### Новая безопасная реализация

Реализована система безопасного хранения с:

1. **Серверное хранение** (Vercel Serverless Functions)
   - Данные хранятся на сервере, а не в браузере
   - Шифрование данных перед сохранением (AES-256-CBC)
   - Изоляция данных по пользователям

2. **Аутентификация через OTP**
   - Одноразовые коды отправляются на Telegram или телефон
   - Сессионные токены для доступа к данным
   - Автоматическое истечение сессий (30 дней)

3. **Шифрование**
   - Все данные шифруются перед сохранением
   - Ключ шифрования хранится в переменных окружения
   - Данные расшифровываются только при запросе авторизованным пользователем

## Настройка для продакшена

### 1. Установка зависимостей

```bash
npm install @vercel/node
```

### 2. Настройка переменных окружения

В Vercel Dashboard → Project Settings → Environment Variables добавьте:

```
ENCRYPTION_KEY=<32-байтовый hex ключ>
```

Для генерации ключа:
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3. Настройка отправки OTP

**Для Telegram:**
- Используйте Telegram Bot API для отправки OTP пользователю
- Обновите `api/auth/send-otp.ts` для отправки через бота

**Для SMS:**
- Используйте сервис типа Twilio, AWS SNS или аналогичный
- Обновите `api/auth/send-otp.ts` для отправки SMS

### 4. Замена in-memory хранилища на базу данных

Текущая реализация использует in-memory хранилище (Map), которое:
- Очищается при перезапуске сервера
- Не масштабируется

**Рекомендуется использовать:**
- **Vercel KV** (Redis) для OTP и сессий
- **Vercel Postgres** или **Supabase** для анкет

Пример миграции на Vercel KV:
```typescript
import { kv } from '@vercel/kv';

// Вместо Map
await kv.set(`otp:${contactIdentifier}`, JSON.stringify({ code, expiresAt }), { ex: 600 });
const stored = await kv.get(`otp:${contactIdentifier}`);
```

### 5. Обновление клиентского кода

После настройки API, обновите `src/lib/form-utils.ts` для использования `src/lib/api-client.ts` вместо `localStorage`.

## GDPR/DSGVO соответствие

- ✅ Пользователи могут запросить удаление своих данных
- ✅ Данные шифруются при хранении
- ✅ Доступ только авторизованным пользователям
- ✅ Сессии автоматически истекают
- ✅ Логирование минимально (только ошибки)

## Рекомендации

1. **Используйте HTTPS** (обязательно в продакшене)
2. **Настройте CORS** для ограничения доступа
3. **Регулярно ротируйте ключи шифрования**
4. **Используйте rate limiting** для защиты от брутфорса
5. **Логируйте попытки доступа** для аудита
6. **Регулярно обновляйте зависимости**

## Миграция с localStorage

Для миграции существующих данных из localStorage:

1. Пользователь должен пройти аутентификацию через OTP
2. После успешной аутентификации, загрузить данные из localStorage
3. Сохранить их через новый API
4. Очистить localStorage
